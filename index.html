<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Realtime Button Counter + History + CSV</title>

  <!-- Firebase compat SDKs for Realtime DB -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; }
    button { padding: 10px 18px; margin: 10px; font-size: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 30px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
  </style>
</head>
<body>

<h1>Global Button Counter (Realtime DB)</h1>

<div>
  <button id="btn1">Feeding</button>
  <span id="count_button1">0</span>
</div>

<div>
  <button id="btn2">Diaper</button>
  <span id="count_button2">0</span>
</div>

<div>
  <button id="btn3">Nap</button>
  <span id="count_button3">0</span>
</div>

<h2>Click History</h2>
<button id="exportCSV">Export as CSV</button>

<table id="historyTable">
  <thead>
    <tr>
      <th>Timestamp</th>
      <th>Button</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // --- Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyAIyugMsDbtGBzNcrDQgUzrQxMIQAqgVO4",
    authDomain: "global-button-counter-7ffa6.firebaseapp.com",
    databaseURL: "https://global-button-counter-7ffa6-default-rtdb.firebaseio.com",
    projectId: "global-button-counter-7ffa6",
    storageBucket: "global-button-counter-7ffa6.firebasestorage.app",
    messagingSenderId: "779296250516",
    appId: "1:779296250516:web:23999491482b288aebb281",
    measurementId: "G-FYYENFEG3Q",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const countersRef = db.ref("counters");
  const historyRef = db.ref("history");

  // Ensure counters exist
  countersRef.once("value", snap => {
    if (!snap.exists()) {
      countersRef.set({
        button1: 0,
        button2: 0,
        button3: 0
      });
    }
  });

  // --- Record click function ---
  function recordClick(buttonKey) {
    countersRef.child(buttonKey).transaction(current => (current || 0) + 1);
    // Save human-readable button name for history
    let buttonName = buttonKey === "button1" ? "Feeding" :
                     buttonKey === "button2" ? "Diaper" : "Nap";
    historyRef.push({
      button: buttonName,
      timestamp: Date.now()
    });
  }

  // --- Real-time counters ---
  countersRef.on("value", snap => {
    const data = snap.val() || {};
    document.getElementById("count_button1").textContent = data.button1 || 0;
    document.getElementById("count_button2").textContent = data.button2 || 0;
    document.getElementById("count_button3").textContent = data.button3 || 0;
  });

  // --- Real-time history table ---
  const tbody = document.querySelector("#historyTable tbody");
  historyRef.limitToLast(500).on("value", snap => {
    const data = snap.val();
    tbody.innerHTML = "";
    if (!data) return;
    const rows = Object.values(data).sort((a,b) => b.timestamp - a.timestamp);
    rows.forEach(r => {
      const tr = document.createElement("tr");
      const timeStr = new Date(r.timestamp).toLocaleString();
      tr.innerHTML = `<td>${timeStr}</td><td>${r.button}</td>`;
      tbody.appendChild(tr);
    });
  });

  // --- Export CSV ---
  function exportCSV() {
    historyRef.once("value").then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        alert("No history to export.");
        return;
      }
      let csv = "timestamp,button\n";
      Object.values(data)
        .sort((a,b) => a.timestamp - b.timestamp)
        .forEach(r => {
          csv += `${new Date(r.timestamp).toISOString()},${r.button}\n`;
        });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "button_history.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  }

  // --- Attach event listeners ---
  document.getElementById("btn1").addEventListener("click", () => recordClick("button1"));
  document.getElementById("btn2").addEventListener("click", () => recordClick("button2"));
  document.getElementById("btn3").addEventListener("click", () => recordClick("button3"));
  document.getElementById("exportCSV").addEventListener("click", exportCSV);

});
</script>

</body>
</html>
