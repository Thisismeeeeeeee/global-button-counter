<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Button Counter with History + CSV Export</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 40px auto;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    table th, table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    table th {
      background: #eee;
    }
  </style>
</head>
<body>

<h1>Global Button Counter</h1>

<div>
  <button onclick="recordClick('button1')">Button 1</button>
  <span id="count_button1">0</span>
</div>

<div>
  <button onclick="recordClick('button2')">Button 2</button>
  <span id="count_button2">0</span>
</div>

<div>
  <button onclick="recordClick('button3')">Button 3</button>
  <span id="count_button3">0</span>
</div>

<h2>Click History</h2>
<button onclick="exportCSV()">Export as CSV</button>

<table id="historyTable">
  <thead>
    <tr>
      <th>Timestamp</th>
      <th>Button</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  // --- YOUR FIREBASE CONFIG HERE ---
  const firebaseConfig = {
    apiKey: "AIzaSyAIyugMsDbtGBzNcrDQgUzrQxMIQAqgVO4",
    authDomain: "global-button-counter-7ffa6.firebaseapp.com",
    databaseURL: "https://global-button-counter-7ffa6-default-rtdb.firebaseio.com",
    projectId: "global-button-counter-7ffa6",
    storageBucket: "global-button-counter-7ffa6.firebasestorage.app",
    messagingSenderId: "779296250516",
    appId: "1:779296250516:web:23999491482b288aebb281",
    measurementId: "G-FYYENFEG3Q"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const counterDoc = db.collection("buttonData").doc("counters");
  const historyCollection = db.collection("buttonHistory");

  // --- Record Button Click ---
  async function recordClick(buttonName) {
    const now = new Date();

    // Update counter (increment)
    await counterDoc.update({
      [buttonName]: firebase.firestore.FieldValue.increment(1)
    });

    // Add a history record
    await historyCollection.add({
      button: buttonName,
      timestamp: now
    });
  }

  // --- Real-time Counter Listener ---
  counterDoc.onSnapshot((doc) => {
    if (doc.exists) {
      const data = doc.data();
      document.getElementById("count_button1").textContent = data.button1 || 0;
      document.getElementById("count_button2").textContent = data.button2 || 0;
      document.getElementById("count_button3").textContent = data.button3 || 0;
    }
  });

  // --- Real-time History Table Listener ---
  historyCollection.orderBy("timestamp", "desc").onSnapshot((snapshot) => {
    const tbody = document.querySelector("#historyTable tbody");
    tbody.innerHTML = ""; // Clear existing rows

    snapshot.forEach(doc => {
      const record = doc.data();
      const tr = document.createElement("tr");

      const timeStr = record.timestamp.toDate().toLocaleString();

      tr.innerHTML = `
        <td>${timeStr}</td>
        <td>${record.button}</td>
      `;
      tbody.appendChild(tr);
    });
  });

  // --- CSV Export ---
  async function exportCSV() {
    const snapshot = await historyCollection.orderBy("timestamp", "asc").get();

    let csv = "timestamp,button\n";

    snapshot.forEach(doc => {
      const r = doc.data();
      const isoTime = r.timestamp.toDate().toISOString();
      csv += `${isoTime},${r.button}\n`;
    });

    // Create a downloadable CSV file
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "button_history.csv";
    a.click();

    URL.revokeObjectURL(url);
  }
</script>

</body>
</html>
